name: CI/CD Pipeline Developer version Trainer FastAPI Application for Oasis of Clear Code

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Choose the type of deployment Dev version Trainer FastAPI Application for Oasis of Clear Code'
        required: true
        default: 'application'
        type: choice
        options:
          - application
          - infrastructure
          - full

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub
      - name: üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub
        run: |
          echo "::add-mask::${{ secrets.DOCKER_PASSWORD }}"
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin

   # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SSH-–∫–ª—é—á–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
      - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          name: tfa_dev_key
          known_hosts: 'github.com'


      # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .ssh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      - name: üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .ssh
        run: mkdir -p ${{ secrets.DEV_SERVER_PORT }} ~/.ssh

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –¥–ª—è SSH-–∫–ª—é—á–∞
      - name: üîí –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ SSH-–∫–ª—é—á—É
        run: chmod 600 ~/.ssh/tfa_dev_key

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GitHub –≤ known_hosts
      - name: üåê –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GitHub –≤ known_hosts
        run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –≤ known_hosts
      - name: üñ•Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ known_hosts
        run: |
          if ! ssh-keyscan -p ${{ secrets.DEV_SERVER_PORT }} -H ${{ secrets.DEV_SERVER_IP }} >> ~/.ssh/known_hosts; then
            echo "Server not found, skipping."
          fi

      - name: üîç –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ known_hosts
        run: cat ~/.ssh/known_hosts

      - name: üîê –ü—Ä–∞–≤–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .ssh
        run: chmod 700 ~/.ssh

      - name: üßæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è known_hosts
        run: ls -la ~/.ssh/


      # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSH-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
      - name: üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ SSH
        run: ssh -v -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "echo 'SSH connection successful!'"


      - name: üì¶ –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ Docker (–¥–æ)
        run: docker system df

      # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ —Å—Ç–∞—Ä—Ç–µ
      - name: üöÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ä—Ç–µ –¥–µ–ø–ª–æ—è –≤ Telegram
        run: |
          TYPE="${{ github.event.inputs.deploy_type }}"
          if [[ "$TYPE" == "application" ]]; then
            TARGET="üñ•Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Trainer FastAPI Application for Oasis of Clear Code"
          elif [[ "$TYPE" == "infrastructure" ]]; then
            TARGET="üß© –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Trainer FastAPI Application for Oasis of Clear Code"
          elif [[ "$TYPE" == "mail" ]]; then
            TARGET="üìß –ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å Trainer FastAPI Application for Oasis of Clear Code"
          else
            TARGET="üåê –ü–æ–ª–Ω—ã–π —Å—Ç–µ–∫ Trainer FastAPI Application for Oasis of Clear Code"
          fi
          
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          MESSAGE="üöÄ *–ù–∞—á–∞–ª—Å—è –¥–µ–ø–ª–æ–π ${TARGET}*%0Aüë§ –ê–≤—Ç–æ—Ä: $COMMIT_AUTHOR%0Aüìù –ö–æ–º–º–∏—Ç: $COMMIT_MESSAGE"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN_FOR_SEND_TELEBOT }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID_FOR_SEND }} -d text="$MESSAGE" -d parse_mode="Markdown"

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Node.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å standard-version
      - name: üü© –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ standard-version
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: npm install

      # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG.md
      - name: üîñ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏ CHANGELOG
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        id: version
        run: |
          npx standard-version
          VERSION=$(node -p "require('./package.json').version")
          echo $VERSION > version.txt
          echo "VERSION_TAG=$VERSION" >> $GITHUB_ENV

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: git status

      # –ö–æ–º–º–∏—Ç –∏ –ø—É—à –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: ‚úÖ –ö–æ–º–º–∏—Ç –≤–µ—Ä—Å–∏–∏ –∏ CHANGELOG
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: |
          git add CHANGELOG.md version.txt
          git commit -m "chore(release): $VERSION_TAG" || echo "No changes to commit"
          git push


      # –°–æ–∑–¥–∞–Ω–∏–µ GitHub —Ä–µ–ª–∏–∑–∞
      - name: üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: "Release ${{ env.VERSION_TAG }}"
          body: ${{ env.LAST_CHANGES }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: |
              python -m pip install --upgrade pip
              pip install pip-tools
              pip-compile --resolver=backtracking requirements.in
              pip install -r requirements.txt
          

      - name: üìú –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ CHANGELOG
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        id: changelog_python
        run: |
          pip install git-changelog
          python generate_changelog_git_changelog.py
          cat .version_env >> $GITHUB_ENV


      # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ
      - name: üßæ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        id: deploy_message
        run: |
          TYPE="${{ github.event.inputs.deploy_type }}"
          if [[ "$TYPE" == "application" ]]; then
            TARGET="üñ•Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Trainer FastAPI Application for Oasis of Clear Code"
          elif [[ "$TYPE" == "infrastructure" ]]; then
            TARGET="üß© –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Trainer FastAPI Application for Oasis of Clear Code"
          elif [[ "$TYPE" == "mail" ]]; then
            TARGET="üìß –ü–æ—á—Ç–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å Trainer FastAPI Application for Oasis of Clear Code"
          else
            TARGET="üåê –ü–æ–ª–Ω—ã–π —Å—Ç–µ–∫ Trainer FastAPI Application for Oasis of Clear Code"
          fi
      
          VERSION="${{ env.VERSION_TAG }}"
          if [[ -z "$VERSION" ]]; then VERSION="–Ω–µ —É–∫–∞–∑–∞–Ω–∞"; fi
      
          RELEASE_URL="https://github.com/OasisOfCleanCode/TrainerFastAPI/releases/tag/$VERSION"
          MESSAGE="üéâ *${TARGET} –∑–∞–¥–µ–ø–ª–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!*%0A"
          MESSAGE+="üß© *–í–µ—Ä—Å–∏—è:* _$VERSION_%0A"
          MESSAGE+="üìÖ *–î–∞—Ç–∞:* _$(date +%d.%m.%Y)%0A"
          MESSAGE+="üìù *–ò–∑–º–µ–Ω–µ–Ω–∏—è:*%0A*${{ env.LAST_CHANGES_HEADER }}*%0A${{ env.LAST_CHANGES_CONTENT }}%0A"
          MESSAGE+="üîó [–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–ª–∏–∑—É]($RELEASE_URL)"
          echo "MESSAGE=$MESSAGE" >> $GITHUB_OUTPUT


      # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ Docker –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      - name: üê≥ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: |
          docker build -f Dockerfile -t tfa_app:${{ env.VERSION_TAG }} .

      # –°–æ–∑–¥–∞–Ω–∏–µ mailu.env —Ñ–∞–π–ª–∞
      - name: üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ .env –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
        run: |
              echo "DOMAIN_URL=https://tfa.occ.dev/" >> .env
              echo "BASE_TFA_API_URL=https://api.tfa.occ.dev/" >> .env
              echo "BASE_TFA_MEDIA_URL=https://media.tfa.occ.dev" >> .env
              echo "BASE_TG_MEDIA_URL=https://tg.tfa.occ.dev" >> .env
              echo "APP_MODE=devveloper" >> .env
              echo "TFA_TOKEN_ACCESS_SECRET_KEY=${{ secrets.TFA_TOKEN_ACCESS_SECRET_KEY }}" >> .env
              echo "TELEGRAM_TOKEN_FOR_SEND_TELEBOT=${{ secrets.TELEGRAM_TOKEN_FOR_SEND_TELEBOT }}" >> .env
              echo "CHAT_ID_FOR_SEND=${{ secrets.CHAT_ID_FOR_SEND }}" >> .env          
              echo "CATALOG_PSTGR_NAME=${{ secrets.CATALOG_PSTGR_NAME }}" >> .env
              echo "CATALOG_PSTGR_USER=${{ secrets.CATALOG_PSTGR_USER }}" >> .env
              echo "CATALOG_PSTGR_PASS=${{secrets.CATALOG_PSTGR_PASS}}" >> .env
              echo "CATALOG_PSTGR_HOST=${{secrets.CATALOG_PSTGR_HOST}}" >> .env
              echo "CATALOG_PSTGR_PORT=${{secrets.CATALOG_PSTGR_PORT}}" >> .env
              echo "MINIO_USER=${{ secrets.MINIO_USER }}" >> .env
              echo "MINIO_PASS=${{ secrets.MINIO_PASS }}" >> .env
              echo "MINIO_CATALOG_NAME=${{secrets.MINIO_CATALOG_NAME}}" >> .env
              echo "MINIO_HOST=minio_noda1" >> .env
              echo "MINIO_PORT=${{secrets.MINIO_PORT}}" >> .env 
              echo "MINIO_DOMAIN=https://2minio.anwill.fun" >> .env 
              echo "MINIO_SERVER_URL=https://2minio.anwill.fun/noda1" >> .env 
              echo "MINIO_BROWSER_REDIRECT_URL=https://2minio.anwill.fun/ui" >> .env 
              echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> .env
              echo "RABBITMQ_PASS=${{ secrets.RABBITMQ_PASS }}" >> .env
              echo "RABBITMQ_HOST=${{secrets.RABBITMQ_HOST}}" >> .env
              echo "RABBITMQ_PORT=${{secrets.RABBITMQ_PORT}}" >> .env
              echo "REDIS_HOST=${{secrets.REDIS_HOST}}" >> .env
              echo "REDIS_PORT=${{secrets.REDIS_PORT}}" >> .env
              echo "REDIS_BAN_LIST_INDEX=${{secrets.REDIS_BAN_LIST_INDEX}}" >> .env
              echo "REDIS_USER_INDEX=${{secrets.REDIS_USER_INDEX}}" >> .env
              echo "REDIS_CATALOG_INDEX=${{secrets.REDIS_CATALOG_INDEX}}" >> .env
              echo "REDIS_PLATFORM_INDEX=${{secrets.REDIS_PLATFORM_INDEX}}" >> .env
              echo "REDIS_WIDGET_INDEX=${{secrets.REDIS_WIDGET_INDEX}}" >> .env
              echo "REDIS_CELERY_INDEX=${{secrets.REDIS_CELERY_INDEX}}" >> .env
              echo "REDIS_TASKIQ_INDEX=${{secrets.REDIS_TASKIQ_INDEX}}" >> .env
              echo "VERSION_TAG=${{ env.VERSION_TAG }}" >> .env
              echo "MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}" >> .env
              echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env
              echo "MAIL_PORT=${{secrets.MAIL_PORT}}" >> .env
              echo "MAIL_SERVER=${{secrets.MAIL_SERVER}}" >> .env


      - name: üìÑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          scp -i ~/.ssh/tfa_dev_key -P ${{ secrets.DEV_SERVER_PORT }} .env ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }}:/tfa_projects/backend/tfa/.env


      # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: |
          docker save tfa_app:${{ env.VERSION_TAG }} > tfa_app-${{ env.VERSION_TAG }}.tar
          scp -i ~/.ssh/tfa_dev_key -P ${{ secrets.DEV_SERVER_PORT }} tfa_app-${{ env.VERSION_TAG }}.tar ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }}:/tfa_projects/backend/tfa/

      # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä

      # –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        if: ${{ github.event.inputs.deploy_type == 'application' || github.event.inputs.deploy_type == 'full' }}
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "docker load < /tfa_projects/backend/tfa/tfa_app-${{ env.VERSION_TAG }}.tar"



      - name: üåê –°–æ–∑–¥–∞—Ç—å Docker Network, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} << 'EOF'
            docker network inspect tapi_dev_network >/dev/null 2>&1 || \
            docker network create \
              --driver bridge \
              --subnet=172.18.0.0/16 \
              --gateway=172.18.0.1 \
              --attachable \
              tapi_dev_network
          EOF

      - name: üß† –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–µ—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        run: |
          docker network inspect tapi_dev_network >/dev/null 2>&1 || \
          docker network create \
            --subnet=172.0.0.0/16 \
            --gateway=172.0.0.1 \
            tapi_dev_network


      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
      - name: ‚öôÔ∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–µ–ø–ª–æ—è
        id: deploy_file
        run: |
          if [ "${{ github.event.inputs.deploy_type }}" == "application" ]; then
            echo "COMPOSE_FILE=compose.catalog.app.dev.yml" >> $GITHUB_ENV
            echo "SERVICE_NAME=" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.deploy_type }}" == "infrastructure" ]; then
            echo "COMPOSE_FILE=compose.infrastructure.dev.yml" >> $GITHUB_ENV
            echo "SERVICE_NAME=" >> $GITHUB_ENV
          else
            echo "COMPOSE_FILE=compose.catalog.full.dev.yml" >> $GITHUB_ENV
            echo "SERVICE_NAME=" >> $GITHUB_ENV
          fi

      # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ Docker Compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          scp -i ~/.ssh/tfa_dev_key -P ${{ secrets.DEV_SERVER_PORT }} $COMPOSE_FILE ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }}:/tfa_projects/backend/tfa/compose.yaml
          scp -i ~/.ssh/tfa_dev_key -P ${{ secrets.DEV_SERVER_PORT }} Dockerfile ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }}:/tfa_projects/backend/tfa/Dockerfile
          scp -i ~/.ssh/tfa_dev_key -P ${{ secrets.DEV_SERVER_PORT }} requirements.in ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }}:/tfa_projects/backend/tfa/requirements.in
      

      # –ó–∞–ø—É—Å–∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "
          export VERSION_TAG=${{ env.VERSION_TAG }} && cd /tfa_projects/backend/tfa && 
          docker compose -f compose.yaml up -d --force-recreate"

      # –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "docker images -q --filter 'dangling=true' | xargs -r docker rmi"

      # –û—á–∏—Å—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
      - name: üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "rm -f /tfa_projects/backend/tfa/tfa_app-*"

      # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: ‚ôªÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –æ–±—Ä–∞–∑–æ–≤
        run: |
          ssh -i ~/.ssh/tfa_dev_key -p ${{ secrets.DEV_SERVER_PORT }} ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_IP }} "docker images tfa_app | tail -n +2 | grep -v ${{ env.VERSION_TAG }} | awk '{print \$3}' | xargs -r docker rmi"

      - name: üì¶ –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ Docker (–ø–æ—Å–ª–µ)
        run: docker system df

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
      - name: üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        run: |
          curl -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN_FOR_SEND_TELEBOT }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID_FOR_SEND }} \
          -d text="${{ steps.deploy_message.outputs.MESSAGE }}" \
          -d parse_mode="Markdown"
